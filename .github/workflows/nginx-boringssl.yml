name: Build Nginx with BoringSSL

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: 'Nginx 版本号 (留空表示自动获取最新稳定版)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build golang libpcre3-dev zlib1g-dev curl wget git
          sudo apt-get remove -y libssl-dev

      - name: 解析版本并准备源码
        id: prep
        run: |
          # 获取 Nginx 版本
          INPUT_VERSION="${{ github.event.inputs.nginx_version }}"
          if [ -z "$INPUT_VERSION" ]; then
            VERSION=$(git ls-remote --tags https://github.com/nginx/nginx.git | grep -oP 'refs/tags/release-\K[0-9]+\.[0-9]*[02468]\.[0-9]+' | sort -V | tail -n 1)
          else
            VERSION="$INPUT_VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # 下载 Nginx
          wget -qO nginx.tar.gz https://github.com/nginx/nginx/archive/refs/tags/release-$VERSION.tar.gz
          tar -xzf nginx.tar.gz && mv nginx-release-$VERSION nginx
          
          # 克隆 BoringSSL
          git clone --depth 1 https://boringssl.googlesource.com/boringssl boringssl

      - name: 编译 BoringSSL
        run: |
          cd boringssl
          mkdir build && cd build
          cmake -GNinja ..
          ninja
          # 关键步骤：创建 .openssl 目录结构欺骗 Nginx
          mkdir -p .openssl/lib && cd .openssl
          ln -s ../../include .
          cp ../crypto/libcrypto.a ../ssl/libssl.a lib/

      - name: 编译 Nginx
        run: |
          cd nginx
          
          # 告诉 Nginx 这是一个 BoringSSL 环境
          # 我们不再使用 --with-openssl 指向源码，而是通过 CFLAGS 指向我们刚才做好的目录
          
          ./auto/configure \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_v3_module \
            --with-cc-opt="-I../boringssl/include" \
            --with-ld-opt="-L../boringssl/build/ssl -L../boringssl/build/crypto -lstdc++ -lpthread" \
            --with-http_gzip_static_module \
            --sbin-path=/usr/sbin/nginx \
            --conf-path=/etc/nginx/nginx.conf
            
          make -j$(nproc)
          strip objs/nginx

      - name: 上传二进制
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ env.VERSION }}-boringssl
          path: nginx/objs/nginx
