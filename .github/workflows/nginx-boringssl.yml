name: Build Nginx with BoringSSL

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: 'Nginx 版本号 (留空表示自动获取最新稳定版)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build golang libpcre3-dev zlib1g-dev curl wget git
          # 必须卸载，确保链接的是 BoringSSL 而不是系统 OpenSSL
          sudo apt-get remove -y libssl-dev

      - name: 解析版本并准备源码
        id: prep
        run: |
          INPUT_VERSION="${{ github.event.inputs.nginx_version }}"
          if [ -z "$INPUT_VERSION" ]; then
            VERSION=$(git ls-remote --tags https://github.com/nginx/nginx.git | grep -oP 'refs/tags/release-\K[0-9]+\.[0-9]*[02468]\.[0-9]+' | sort -V | tail -n 1)
          else
            VERSION="$INPUT_VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          wget -qO nginx.tar.gz https://github.com/nginx/nginx/archive/refs/tags/release-$VERSION.tar.gz
          tar -xzf nginx.tar.gz && mv nginx-release-$VERSION nginx
          
          git clone --depth 1 https://boringssl.googlesource.com/boringssl boringssl

      - name: 编译 BoringSSL
        run: |
          cd boringssl
          mkdir build && cd build
          cmake -GNinja -DCMAKE_BUILD_TYPE=Release ..
          ninja
          # 记录下绝对路径供下一步使用
          echo "BORINGSSL_ROOT=$(realpath ..)" >> $GITHUB_ENV

      - name: 编译 Nginx
        run: |
          cd nginx
          
          # 核心逻辑：
          # 1. 不使用 --with-openssl，避免 Nginx 尝试调用 make 编译它
          # 2. 通过 --with-cc-opt 告诉 Nginx 去哪里找头文件
          # 3. 通过 --with-ld-opt 告诉 Nginx 链接具体的 .a 文件
          
          ./auto/configure \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_v3_module \
            --with-http_gzip_static_module \
            --sbin-path=/usr/sbin/nginx \
            --conf-path=/etc/nginx/nginx.conf \
            --with-cc-opt="-I${{ env.BORINGSSL_ROOT }}/include" \
            --with-ld-opt="-L${{ env.BORINGSSL_ROOT }}/build/ssl -L${{ env.BORINGSSL_ROOT }}/build/crypto -lstdc++ -lpthread"
            
          make -j$(nproc)
          strip objs/nginx

      - name: 验证版本
        run: |
          ./nginx/objs/nginx -V

      - name: 上传二进制
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ env.VERSION }}-boringssl
          path: nginx/objs/nginx
