name: Build Nginx with BoringSSL

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: 'Nginx 版本号 (留空表示自动获取最新稳定版)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build golang libpcre3-dev zlib1g-dev curl wget git
          sudo apt-get remove -y libssl-dev

      - name: 解析版本并准备源码
        id: prep
        run: |
          # 获取 Nginx 版本
          INPUT_VERSION="${{ github.event.inputs.nginx_version }}"
          if [ -z "$INPUT_VERSION" ]; then
            VERSION=$(git ls-remote --tags https://github.com/nginx/nginx.git | grep -oP 'refs/tags/release-\K[0-9]+\.[0-9]*[02468]\.[0-9]+' | sort -V | tail -n 1)
          else
            VERSION="$INPUT_VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # 下载 Nginx
          wget -qO nginx.tar.gz https://github.com/nginx/nginx/archive/refs/tags/release-$VERSION.tar.gz
          tar -xzf nginx.tar.gz && mv nginx-release-$VERSION nginx
          
          # 克隆 BoringSSL
          git clone --depth 1 https://boringssl.googlesource.com/boringssl boringssl

      - name: 编译 BoringSSL
        run: |
          cd boringssl
          mkdir build && cd build
          cmake -GNinja -DCMAKE_BUILD_TYPE=Release ..
          ninja
          
          # 自动寻找生成的静态库并建立 Nginx 需要的目录结构
          mkdir -p .openssl/lib
          cd .openssl
          ln -s ../../include .
          
          # 使用 find 确保能找到 libcrypto.a 和 libssl.a（兼容不同构建结构）
          find ../ -name "libcrypto.a" -exec cp {} lib/ \;
          find ../ -name "libssl.a" -exec cp {} lib/ \;

      - name: 编译 Nginx
        run: |
          cd nginx
          
          # 获取 BoringSSL 编译产物的绝对路径
          BORINGSSL_PATH=$(pwd)/../boringssl
          
          # 注意：通过 --with-openssl 指向我们伪装好的 .openssl 目录
          # Nginx 的配置脚本会自动检查该目录下是否存在 include/openssl 和 lib/libssl.a
          ./auto/configure \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_v3_module \
            --with-http_gzip_static_module \
            --sbin-path=/usr/sbin/nginx \
            --conf-path=/etc/nginx/nginx.conf \
            --with-openssl="$BORINGSSL_PATH/build/.openssl" \
            --with-cc-opt="-I$BORINGSSL_PATH/include" \
            --with-ld-opt="-L$BORINGSSL_PATH/build/.openssl/lib -lstdc++ -lpthread"
            
          # 修正 Nginx 试图在 BoringSSL 目录执行 make 的行为
          # 因为我们已经手动编好了，所以创建一个空的 Makefile 骗过 Nginx 的校验
          touch "$BORINGSSL_PATH/build/.openssl/Makefile"
          touch "$BORINGSSL_PATH/build/.openssl/config"

          make -j$(nproc)
          strip objs/nginx

      - name: 上传二进制
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ env.VERSION }}-boringssl
          path: nginx/objs/nginx
