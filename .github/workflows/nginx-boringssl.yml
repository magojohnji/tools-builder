name: Build Nginx with BoringSSL

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: | 
          apt-get update
          apt-get upgrade
          apt-get install -y sudo curl wget unzip build-essential autoconf libtool libpcre3-dev \
                                 zlib1g-dev cmake ninja-build golang git

      - name: Clone and Build BoringSSL
        run: |
          git clone --depth 1 https://boringssl.googlesource.com/boringssl
          cd boringssl
          mkdir build && cd build
          cmake -GNinja ..
          ninja
          # Nginx 编译脚本期望在 .openssl 目录下找到 include 和 lib
          mkdir -p .openssl/lib
          cp crypto/libcrypto.a ssl/libssl.a .openssl/lib/
          cd ..
          ln -s $(pwd)/include .openssl/include
          echo "BORINGSSL_PATH=$(pwd)" >> $GITHUB_ENV

      - name: Download Nginx
        run: |
          # 你可以修改这里来选择特定版本，例如 1.27.4 (Mainline)
          NGINX_VERSION="1.27.4"
          curl -L http://nginx.org/download/nginx-$NGINX_VERSION.tar.gz -o nginx.tar.gz
          tar -zxf nginx.tar.gz
          mv nginx-$NGINX_VERSION nginx-src
          echo "NGINX_VERSION=$NGINX_VERSION" >> $GITHUB_ENV

      - name: Configure and Build Nginx
        run: |
          cd nginx-src
          ./configure \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_v3_module \
            --with-openssl=$BORINGSSL_PATH \
            --with-openssl-opt="no-tests" \
            --prefix=/etc/nginx \
            --sbin-path=/usr/sbin/nginx \
            --conf-path=/etc/nginx/nginx.conf
          
          # 注意：因为 BoringSSL 不需要 Nginx 去执行 'make'，
          # 我们需要手动修改 Nginx 生成的 objs/Makefile 避开 OpenSSL 的构建过程
          sed -i 's#/.openssl/include#/.openssl/include#g' objs/Makefile
          # 这一步是为了防止 Nginx 尝试在 BoringSSL 目录运行 make
          touch $BORINGSSL_PATH/.openssl/include/openssl/ssl.h
          
          make -j$(nproc)

      - name: Prepare Artifact
        run: |
          mkdir -p dist
          cp nginx-src/objs/nginx dist/
          echo "Build finished at $(date)" > dist/info.txt

      - name: Upload Nginx Binary
        uses: actions/upload-artifact@v4
        with:
          name: nginx-boringssl-${{ env.NGINX_VERSION }}
          path: dist/nginx
