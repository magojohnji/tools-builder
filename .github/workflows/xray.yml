name: Xray Core

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Optional tag name to build from (e.g., 1.8.0). If empty, clones from main branch.'
        required: false
        default: ''

jobs:
  build-linux:
    runs-on: ubuntu-latest
    container: debian:latest
    env:
      CGO_ENABLED: 0
      GOOS: linux
      GOARCH: amd64
    steps:
      - name: Install aria2
        run: apt-get update && apt-get install -y aria2 git

      - name: Fetch source code
        run: |
          if [ -z "${{ inputs.tag }}" ]; then
            echo "No tag provided, cloning from main branch..."
            git clone https://github.com/XTLS/Xray-core.git
            cd Xray-core
            git checkout main
          else
            echo "Tag provided: ${{ inputs.tag }}, downloading source archive..."
            aria2c "https://github.com/XTLS/Xray-core/archive/refs/tags/v${{ inputs.tag }}.tar.gz" -o source.tar.gz
            tar xzf source.tar.gz
            mv Xray-core-v${{ inputs.tag }} Xray-core
            cd Xray-core
          fi

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: Xray-core/go.mod
          check-latest: true

      - name: Build Xray (Linux amd64)
        working-directory: Xray-core
        run: |
          go mod download
          go build -o xray -trimpath -ldflags "-s -w -buildid=" ./main

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xray-linux-amd64
          path: Xray-core/xray
